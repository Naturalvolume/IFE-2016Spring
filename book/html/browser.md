# 浏览器
### 单进程浏览器
指浏览器的所有功能模块都运行在同一个进程里，这些模块包含了 网络、插件、js运行环境、渲染引擎和页面等。

单进程浏览器的**缺点**：
- 不稳定：可以用插件实现诸如web视频、web游戏等各种强大的功能，但是插件最容易出问题，所以插件的意外崩溃会引起整个浏览器的崩溃
- 不流畅：所有页面的渲染模块、js执行环境以及插件都运行在同一个线程中，意味着同一时刻只能有一个模块可以执行
- 不安全：通过插件可以获取到操作系统的任意资源，所以当运行一个插件时也就意味着插件可以操作电脑，若是个恶意插件，那就会释放病毒、窃取账号密码，引发安全性问题。

所以单浏览器会出现这样的场景：当用浏览器打开多个页面时，突然某个页面崩溃了或者失去响应，那么可能整个浏览器都会崩溃或者无响应。
### chrome 打开一个页面需要启动多少进程？
chrome 是第一个采取多进程架构的浏览器
- 浏览器进程：负责界面显示、用户交互、子进程管理、下载资源、管理IPC，同时提供存储等功能；
- 渲染进程：将html、css、js转换为**用户可以交互的网页**，**排版引擎**和**js v8引擎**都在渲染进程中，每个**tab标签**都会创建一个渲染进程，处于安全考虑，渲染进程都运行在**沙箱模式**下（不能读写硬盘上的数据、不能获取操作系统权限）；
- gpu进程：实现3D css效果，UI 界面也采用GPU绘制；
- 网络进程：负责页面的网络资源加载；
- 多个插件进程

##### 进程之间通过IPC机制进行通信
##### 多进程浏览器优点：
- 解决不稳定问题：进程相互隔离，一个页面或插件崩溃时，影响的仅仅是当前页面或者插件进程，不会影响到浏览器和其他页面
- 解决不流畅问题：js运行在渲染进程中，所以js只会阻塞当前渲染页面，不会影响浏览器和其他页面
- 解决内存泄露问题：关闭网页，整个渲染进程也会被关闭，该进程所占用的内存都会被系统回收，解决了浏览器页面内存泄露问题
- 沙箱机制：相当于给插件进程和渲染进程上了锁，沙箱里的程序可以运行，但是不能在硬盘上写入任何数据，也不能在敏感位置读取任何数据

##### 多进程浏览器的缺点
- 更高的资源占用
- 更复杂的体系架构

**主动防御**：发现程序有可疑行为时立即拦截并终止运行
**沙盒技术原理**：发现可疑行为后让程序继续运行，只有发现的确是病毒时才会终止
**沙盒技术运行流程**：让疑似病毒文件的可疑行为在虚拟的沙盒中表演，沙盒会记下它的每一个动作，当疑似病毒充分暴露了病毒属性后，沙盒就会执行**回滚**机制，将病毒的痕迹和动作抹去，恢复系统到正常状态
[浏览器沙盒模型](https://www.cnblogs.com/slly/p/6639173.html)
[Chrome架构：仅仅打开了1个页面，为什么有4个进程？](https://cloud.tencent.com/developer/news/414508)
### 浏览器渲染过程
- 构建dom树：从**网络**或**硬盘**中获得html，将字节解析为文件指定编码字符，根据html规范将字符串转换成各种令牌标签（如html、body等），解析成一个树状对象模型（dom树）
- 样式计算：style标签内的css、内嵌的css、外链css
- 创建布局树：遍历dom树，将所有可见节点加入布局树，计算dom元素的布局信息
- 分层：渲染引擎为特定的节点（如3D变换、页面滚动、设置z-index的定位元素）生成专用的图层，并生成一棵对应的图层树
- 拆分绘制图层：把一个图层的绘制拆分成很多小的绘制指令，把指令按顺序组成一个待绘制列表，列表准备好之后，主线程将绘制列表提交给**合成线程**，合成线程**将图层划分为图块**
- 栅格化：按照视口附近的图块优先生成位图
- 显示：所有图块被栅格化后，合成线程生成绘制图块的命令，将该命令提交给浏览器进程，浏览器最后进行显示

### 会引起回流和重绘的操作
**回流**：
- 常见的几何属性改变：width、height、padding、margin、left、top、border等
- 获取一些需要**立刻计算得到的属性**：offsetTop、offsetLeft、offsetWidth、offsetHeight、scrollTop、scrollLeft、scrollWidth、scrollHeight、clientTop、clientLeft、clientWidth、clientHeight时，浏览器为了获取这些值，也会进行回流
- 调用 getComputedStyle 方法，或IE里的 currentStyle 时，也会触发回流（即时性、准确性）
- 添加或删除可见dom节点
- 浏览器窗口尺寸的变化（resize事件发生时）
- 填充内容的改变：如文本的改变或图片大小改变引起的计算值宽度和高度的改变

**优化一**：
- 浏览器自己的优化：维护一个队列，把所有会引起回流、重绘的操作放入这个队列，等队列中的操作到了一定数量 或 到了一定时间间隔，浏览器就`flush`队列，进行一个批处理，将多次回流、重绘变成一次。

**优化二**：
- 使用**类名合并**改变样式
- 提升为合成层，如使用will-change
  - 合成层的位图会交给gpu合成，比cpu处理要快
  - 只会repaint本身，不会影响到其它层
  - 对 transform 和 opacity，不会触发 layout 和 paint
- 将**需要多次重排的元素**，`position`属性设置为`absolute`或`fixed`，元素脱离了文档流，它的变化不会影响到其他元素
- 若需创建多个dom节点，可使用`DocumentFragment`创建完后一次性的加入`document`

浏览器使用**flush队列**，缓存触发的回流和重绘任务，待队列中任务多起来 或者 到了一定的时间间隔 或 不得已的时候将任务一口气出队，所以，当访问即时属性时，浏览器会为了获得此时此刻、最准确的属性值，将flush队列的任务出队。


